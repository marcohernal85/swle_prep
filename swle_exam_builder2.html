<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PRC SWLE Exam Builder</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#22d3ee;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:40px auto;padding:0 16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:linear-gradient(180deg,#111827, #0b1220);border:1px solid #1f2937;border-radius:18px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .card h2,.card h3{margin:0 0 12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid #243141;color:#9fb0c5;font-size:12px}
    button,select,input[type="file"]{background:#0b1220;color:var(--text);border:1px solid #233045;border-radius:12px;padding:10px 14px;cursor:pointer; transition: border-color 0.2s;}
    button:hover, select:hover, input[type="file"]:hover {border-color:#22d3ee}
    .primary{background:linear-gradient(180deg,#0ea5e9,#22d3ee);color:#001018;border:none}
    .primary:hover{filter:brightness(1.1)}
    .danger{background:#1a0b0b;color:#ffd8d8;border-color:#7f1d1d}
    .success{background:#0b1a14;color:#d1fae5;border-color:#064e3b}
    .warn{background:#1a140b;color:#ffedd5;border-color:#7c2d12}
    .grid{display:grid;gap:16px}
    .grid.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:900px){.grid.g3{grid-template-columns:1fr}.row{flex-direction:column}}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .q{padding:16px;border:1px solid #223046;border-radius:14px;margin:8px 0;background:#0b1220}
    .choice{padding:10px;border:1px solid #263246;border-radius:12px;margin:8px 0;cursor:pointer; transition: all 0.2s;}
    .choice.selected{border-color: var(--accent); background: #1c2e4a;}
    .hide{display:none}
    .rationale{border-left:3px solid #233045;margin-top:6px;padding-left:10px;color:#bcd; font-size: 14px;}
    .progress{height:10px;background:#0b1220;border:1px solid #233045;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#22d3ee,#3b82f6); transition: width 0.3s ease-in-out;}
    .small{font-size:12px}
    .input{width:100%;background:#0b1220;border:1px solid #233045;border-radius:10px;padding:10px;color:var(--text)}
    .help{font-size:12px;color:#9fb0c5; min-height: 16px;}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap}
    .results-summary {margin:18px 0 0 0;padding:16px;border-radius:14px;background:var(--muted);}
    .answer-review {margin:12px 0 0 0;}
    .answer-review .q {background:#171e2b;}
    .answer-review .choice {margin:4px 0;}
    .choice.correct {border-color:#22c55e;background:#062014; color: var(--good);}
    .choice.wrong {border-color:#ef4444;background:#1a0b0b; color: var(--bad);}
    .choice.selected {border-color: var(--accent); background: #1c2e4a;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="card" style="flex:1 1 460px">
        <h2>PRC SWLE Exam Builder</h2>
        <div class="pillbar">
          <span class="pill">Subjects: HBSE, SWPPS, Practice I-III</span>
          <span class="pill">Difficulty split: 30% E • 40% M • 30% D</span>
          <span class="pill">Local Data Bank via <b>localStorage</b></span>
        </div>
        <p class="muted">Build 100-item exams per subject aligned to the PRC Table of Specifications. Import your JSON files to populate the question bank and start practicing.</p>
        <div class="grid g3">
          <div class="card">
            <h3>Build Exam</h3>
            <label>Subject
              <select id="subjectSelect" class="input">
                <option>HBSE</option>
                <option>SWPPS</option>
                <option>Practice I</option>
                <option>Practice II</option>
                <option>Practice III</option>
              </select>
            </label>
            <label>Target items <input id="targetCount" class="input" type="number" value="100" min="10" max="200"/></label>
            <div class="flex" style="margin-top:10px">
              <button class="primary" id="btnBuild">Build Exam</button>
            </div>
            <div id="buildMsg" class="help" style="margin-top:8px"></div>
          </div>
          <div class="card">
            <h3>Bank: Import / Export</h3>
            <div>
              <input type="file" id="importFile" accept="application/json" style="width:100%;box-sizing:border-box;"/>
            </div>
            <div class="flex" style="margin-top:10px">
              <button id="btnImport">Import</button>
            </div>
             <div id="importMsg" class="help" style="margin-top:8px"></div>
          </div>
          <div class="card">
            <h3>Data Bank Status</h3>
            <div id="bankStatus" class="help">No data loaded. Import a file to begin.</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Exam Panel - single question mode -->
    <div class="card" id="examPanel" style="margin-top:16px" hidden>
      <div class="flex">
        <h3 style="margin:0">Exam Mode</h3>
        <div class="right pillbar">
          <span class="pill" id="metaCount">Question: 0/0</span>
        </div>
      </div>
      <div class="progress" style="margin:12px 0 6px"><div class="bar" id="bar" style="width:0%"></div></div>
      <div id="singleQuestionPanel"></div>
      <div class="flex" style="margin-top:12px">
        <button id="btnFinishExam" class="primary hide">Finish Exam</button>
      </div>
    </div>
    <!-- Results Panel -->
    <div class="card hide" id="resultsPanel" style="margin-top:16px">
      <h3>Exam Results</h3>
      <div id="resultsSummary" class="results-summary"></div>
      <div id="answerReview" class="answer-review"></div>
      <div class="flex" style="margin-top:12px">
        <button id="btnRestartExam" class="primary">Restart Exam</button>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // State
      let currentExamQuestions = [];
      let userAnswers = {};
      let currentQuestionIndex = 0;
      const subjectSelect = document.getElementById('subjectSelect');
      const targetCount = document.getElementById('targetCount');
      const btnBuild = document.getElementById('btnBuild');
      const buildMsg = document.getElementById('buildMsg');
      const importFile = document.getElementById('importFile');
      const btnImport = document.getElementById('btnImport');
      const importMsg = document.getElementById('importMsg');
      const bankStatus = document.getElementById('bankStatus');
      // Exam panel
      const examPanel = document.getElementById('examPanel');
      const singleQuestionPanel = document.getElementById('singleQuestionPanel');
      const metaCount = document.getElementById('metaCount');
      const bar = document.getElementById('bar');
      const btnFinishExam = document.getElementById('btnFinishExam');
      // Results panel
      const resultsPanel = document.getElementById('resultsPanel');
      const resultsSummary = document.getElementById('resultsSummary');
      const answerReview = document.getElementById('answerReview');
      const btnRestartExam = document.getElementById('btnRestartExam');

      // PRC TOS
      const ALLOCATIONS = {
        HBSE: {difficultySplit:{Easy:0.30, Moderate:0.40, Difficult:0.30},topics:[{key:"A1",topic:"Philippine Social Realities & Social Work Concepts/Tools",count:17},{key:"A2",topic:"Anatomy of Social Problems & Theories",count:3},{key:"B",topic:"Filipino Personality & Social Work",count:20},{key:"C",topic:"Social Work & Social Deviation",count:20},{key:"D",topic:"Social Environment: Family/Group/Community/Org",count:20},{key:"E",topic:"Social Change & Development Perspectives",count:20},]},
        SWPPS: {difficultySplit:{Easy:0.30, Moderate:0.40, Difficult:0.30},topics:[{key:"A",topic:"Philippine Social Welfare & Development: History, Philosophy, Values",count:20},{key:"B",topic:"Social Welfare Policies, Laws, and Programs",count:30},{key:"C",topic:"Fields of Social Work & Delivery Systems",count:30},{key:"D",topic:"International and Regional Developments",count:20}]},
        "Practice I": {difficultySplit:{Easy:0.30, Moderate:0.40, Difficult:0.30},topics:[{key:"A",topic:"Social Work Practice with Individuals (Casework)",count:40},{key:"B",topic:"Theories, Methods, and Approaches in Casework",count:30},{key:"C",topic:"Practice Skills and Techniques",count:30}]},
        "Practice II": {difficultySplit:{Easy:0.30, Moderate:0.40, Difficult:0.30},topics:[{key:"A",topic:"Social Work Practice with Groups",count:40},{key:"B",topic:"Theories, Methods, and Approaches in Group Work",count:30},{key:"C",topic:"Practice Skills and Techniques in Group Work",count:30}]},
        "Practice III": {difficultySplit:{Easy:0.30, Moderate:0.40, Difficult:0.30},topics:[{key:"A",topic:"Social Work Practice with Communities & Organizations",count:40},{key:"B",topic:"Theories, Methods, and Approaches in Community/Org Practice",count:30},{key:"C",topic:"Practice Skills and Techniques in Community/Org Practice",count:30}]},
      };

      // Utility
      const shuffle = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      };

      // Used questions logic
      function getUsedQuestionIds(subject) {
        return JSON.parse(localStorage.getItem(`used_questions_${subject}`) || '[]');
      }
      function setUsedQuestionIds(subject, ids) {
        localStorage.setItem(`used_questions_${subject}`, JSON.stringify(ids));
      }
      function resetUsedQuestionIds(subject) {
        localStorage.removeItem(`used_questions_${subject}`);
      }

      const updateBankStatus = () => {
        let statusHTML = '';
        Object.keys(ALLOCATIONS).forEach(subject => {
          const questions = JSON.parse(localStorage.getItem(`questions_${subject}`) || '[]');
          if (questions.length > 0) {
            statusHTML += `<div><b>${subject}:</b> ${questions.length} items</div>`;
          }
        });
        bankStatus.innerHTML = statusHTML || 'No data loaded. Import a file to begin.';
      };

      /*** Import logic ***/
      btnImport.addEventListener('click', () => {
        if (importFile.files.length === 0) {
          importMsg.textContent = 'Please select a file to import.';
          importMsg.style.color = 'var(--warn)';
          return;
        }
        const file = importFile.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (!Array.isArray(data) || data.length === 0) throw new Error('JSON must be a non-empty array.');
            const subject = data[0].subject;
            if (!subject || !ALLOCATIONS[subject]) throw new Error('JSON items must have a valid "subject" property.');
            const existingData = JSON.parse(localStorage.getItem(`questions_${subject}`) || '[]');
            const combinedData = [...existingData, ...data];
            const uniqueData = Array.from(new Map(combinedData.map(item => [item.id, item])).values());
            localStorage.setItem(`questions_${subject}`, JSON.stringify(uniqueData));
            importMsg.textContent = `Imported and merged ${data.length} items for ${subject}. Total: ${uniqueData.length}.`;
            importMsg.style.color = 'var(--good)';
            updateBankStatus();
            importFile.value = '';
          } catch (e) {
            importMsg.textContent = `Error: ${e.message}`;
            importMsg.style.color = 'var(--bad)';
          }
        };
        reader.readAsText(file);
      });

      /*** Exam building with non-repeating logic ***/
      btnBuild.addEventListener('click', () => {
        const subject = subjectSelect.value;
        const totalItems = parseInt(targetCount.value);
        const bank = JSON.parse(localStorage.getItem(`questions_${subject}`) || '[]');
        if (bank.length === 0) {
          buildMsg.textContent = `Question bank for ${subject} is empty. Please import a file.`;
          buildMsg.style.color = 'var(--warn)';
          return;
        }
        // Get used IDs for this subject
        let usedIds = getUsedQuestionIds(subject);
        // Filter out used questions
        let unusedQuestions = bank.filter(q => !usedIds.includes(q.id));
        // If not enough unused, reset used and start over
        if (unusedQuestions.length < totalItems) {
          resetUsedQuestionIds(subject);
          usedIds = [];
          unusedQuestions = bank;
          buildMsg.textContent = `All questions have been used. The pool is reset.`;
          buildMsg.style.color = 'var(--warn)';
        } else {
          buildMsg.textContent = '';
        }
        // Allocate by difficulty
        const allocation = ALLOCATIONS[subject];
        let selectedQuestions = [];
        let tempBank = shuffle([...unusedQuestions]);
        const requiredEasy = Math.round(totalItems * allocation.difficultySplit.Easy);
        const requiredMod = Math.round(totalItems * allocation.difficultySplit.Moderate);
        const requiredDiff = totalItems - requiredEasy - requiredMod;
        const easyQs = tempBank.filter(q => q.difficulty === 'Easy');
        const modQs = tempBank.filter(q => q.difficulty === 'Moderate');
        const diffQs = tempBank.filter(q => q.difficulty === 'Difficult');
        selectedQuestions.push(...easyQs.slice(0, requiredEasy));
        selectedQuestions.push(...modQs.slice(0, requiredMod));
        selectedQuestions.push(...diffQs.slice(0, requiredDiff));
        if (selectedQuestions.length < totalItems) {
            buildMsg.textContent = `Warning: Not enough questions in the bank to meet the ${totalItems} target. Built with ${selectedQuestions.length}.`;
            buildMsg.style.color = 'var(--warn)';
        } else if (!buildMsg.textContent) {
            buildMsg.textContent = `Successfully built exam with ${selectedQuestions.length} items.`;
            buildMsg.style.color = 'var(--good)';
        }
        currentExamQuestions = shuffle(selectedQuestions);
        userAnswers = {};
        currentQuestionIndex = 0;
        resultsPanel.classList.add('hide');
        examPanel.hidden = false;
        renderSingleQuestion();
      });

      /*** Single question view logic ***/
      function renderSingleQuestion() {
        // If exam is done
        if (currentQuestionIndex >= currentExamQuestions.length) {
          examPanel.hidden = true;
          // Record the used questions for this attempt
          const subject = subjectSelect.value;
          let usedIds = getUsedQuestionIds(subject);
          let newUsedIds = [...usedIds];
          currentExamQuestions.forEach(q => {
            if (!newUsedIds.includes(q.id)) newUsedIds.push(q.id);
          });
          setUsedQuestionIds(subject, newUsedIds);
          showResultsPanel();
          return;
        }
        // Prepare
        const q = currentExamQuestions[currentQuestionIndex];
        singleQuestionPanel.innerHTML = '';
        // Progress
        metaCount.textContent = `Question: ${currentQuestionIndex + 1}/${currentExamQuestions.length}`;
        bar.style.width = `${((currentQuestionIndex) / currentExamQuestions.length) * 100}%`;
        // Question
        const questionEl = document.createElement('div');
        questionEl.className = 'q';
        questionEl.innerHTML = `
          <div style="margin-bottom:6px;font-size:13px;color:#9fb0c5;">
            <span>Topic: ${q.topic || 'N/A'}</span> • 
            <span>Difficulty: ${q.difficulty}</span>
          </div>
          <div style="margin-bottom:8px;"><b>${currentQuestionIndex + 1}.</b> ${q.stem}</div>
          <div class="choices"></div>
        `;
        const choicesDiv = questionEl.querySelector('.choices');
        // Shuffle choices
        const shuffledChoices = shuffle([...q.choices]);
        shuffledChoices.forEach((choice, idx) => {
          const origIdx = q.choices.indexOf(choice);
          const choiceEl = document.createElement('div');
          choiceEl.className = 'choice';
          choiceEl.dataset.index = origIdx;
          choiceEl.textContent = choice;
          choiceEl.tabIndex = 0;
          // Highlight if already answered
          if (userAnswers[q.id] !== undefined && userAnswers[q.id] === origIdx) {
            choiceEl.classList.add('selected');
          }
          choiceEl.addEventListener('click', () => {
            Array.from(choicesDiv.children).forEach(c => c.classList.remove('selected'));
            choiceEl.classList.add('selected');
            userAnswers[q.id] = origIdx;
            btnNext.disabled = false;
          });
          choiceEl.addEventListener('keydown', (e) => {
            if (e.key === "Enter" || e.key === " ") {
              choiceEl.click();
            }
          });
          choicesDiv.appendChild(choiceEl);
        });
        singleQuestionPanel.appendChild(questionEl);
        // Next button logic
        let btnNext = document.getElementById('btnNext');
        if (btnNext) btnNext.remove();
        btnNext = document.createElement('button');
        btnNext.id = 'btnNext';
        btnNext.className = 'primary';
        btnNext.style.marginTop = '14px';
        btnNext.textContent = (currentQuestionIndex < currentExamQuestions.length - 1) ? 'Next' : 'Finish Exam';
        btnNext.disabled = userAnswers[q.id] === undefined;
        btnNext.onclick = function() {
          currentQuestionIndex++;
          if (currentQuestionIndex < currentExamQuestions.length) {
            renderSingleQuestion();
          } else {
            examPanel.hidden = true;
            // Record the used questions for this attempt
            const subject = subjectSelect.value;
            let usedIds = getUsedQuestionIds(subject);
            let newUsedIds = [...usedIds];
            currentExamQuestions.forEach(q => {
              if (!newUsedIds.includes(q.id)) newUsedIds.push(q.id);
            });
            setUsedQuestionIds(subject, newUsedIds);
            showResultsPanel();
          }
        };
        singleQuestionPanel.appendChild(btnNext);
        btnFinishExam.classList.add('hide');
      }

      /*** Results panel ***/
      function showResultsPanel() {
        resultsPanel.classList.remove('hide');
        // Score
        let correctCount = 0;
        currentExamQuestions.forEach(q => {
          if (userAnswers[q.id] === q.answerIndex) correctCount++;
        });
        const total = currentExamQuestions.length;
        const scorePercent = Math.round((correctCount / total) * 100);
        resultsSummary.innerHTML = `
          <div><b>Score:</b> ${correctCount} / ${total} (${scorePercent}%)</div>
        `;
        // Review
        answerReview.innerHTML = '';
        currentExamQuestions.forEach((q, idx) => {
          const userAnswered = userAnswers[q.id];
          const reviewEl = document.createElement('div');
          reviewEl.className = 'q';
          let choicesHTML = '';
          q.choices.forEach((choice, i) => {
            let classes = "choice";
            if (userAnswered === i) classes += " selected";
            if (i === q.answerIndex) classes += " correct";
            if (userAnswered === i && userAnswered !== q.answerIndex) classes += " wrong";
            choicesHTML += `<div class="${classes}">${choice}</div>`;
          });
          reviewEl.innerHTML = `
            <div style="margin-bottom:6px;font-size:13px;color:#9fb0c5;">
              <span>Topic: ${q.topic || 'N/A'}</span> • 
              <span>Difficulty: ${q.difficulty}</span>
            </div>
            <div style="margin-bottom:8px;"><b>${idx + 1}.</b> ${q.stem}</div>
            <div>${choicesHTML}</div>
            <div class="rationale">${q.rationale || ''}</div>
          `;
          answerReview.appendChild(reviewEl);
        });
      }

      /*** Restart exam logic ***/
      btnRestartExam.addEventListener('click', () => {
        resultsPanel.classList.add('hide');
        currentQuestionIndex = 0;
        userAnswers = {};
        renderSingleQuestion();
        examPanel.hidden = false;
      });

      // Initial
      updateBankStatus();
    });
  </script>
</body>
</html>
